(()=>{"use strict";const e=Array.from(document.getElementsByClassName("tasks-column__footer-button"));function t(){Array.from(document.getElementsByClassName("tasks-column__new-task-form")).forEach((t=>{const n=t.closest(".tasks-column__column-footer"),a=t.closest(".tasks-column").querySelector(".tasks-column__new-task-card"),s=t.closest(".tasks-column__new-task-form"),c=e.find((e=>null===e.parentElement));s.remove(),a.remove(),n.insertAdjacentElement("beforeend",c)}))}class n{constructor(e,t,n){this.textContent=e,this.imageUrl=t,this.imageHeight=n,this.createDate=Date.now()}createTaskContainer(){const e=document.createElement("div");if(e.className="tasks-column__task-container",e.dataset.createDate=this.createDate,this.imageUrl){const t=document.createElement("div");t.className="tasks-column__task-image-container",t.style.backgroundImage=this.imageUrl,t.style.height=this.imageHeight,e.insertAdjacentElement("beforeend",t)}const t=document.createElement("div");t.className="tasks-column__task-text",t.textContent=this.textContent,e.insertAdjacentElement("beforeend",t);const n=document.createElement("button");return n.className="tasks-column__delete-task-button",n.textContent="X",n.addEventListener("click",(e=>{!function(e){const t=e.currentTarget.closest(".tasks-column__task-container"),n=Number(t.dataset.createDate),a=JSON.parse(localStorage.getItem("cardArray")),s=a.findIndex((e=>e.createDate===n));a.splice(s,1),localStorage.setItem("cardArray",JSON.stringify(a)),t.remove()}(e)})),e.insertAdjacentElement("beforeend",n),e}}function a(e,t){const n=document.getElementsByClassName("tasks-column__column-tasks")[t];return Array.from(n.getElementsByClassName("tasks-column__task-container")).findIndex((t=>e.dataset.createDate===t.dataset.createDate))}function s(e){const t=e.closest(".tasks-column").querySelector(".tasks-column__header-text").textContent;return Array.from(document.querySelectorAll(".tasks-column__header-text")).findIndex((e=>e.textContent===t))}function c(){t();const e=this,c=e.closest(".tasks-column"),r=e.closest(".tasks-column__column-footer"),o=c.querySelector(".tasks-column__column-tasks");e.remove();const l=function(){const e={};e.newTaskForm=document.createElement("form"),e.newTaskForm.name="new_task",e.newTaskForm.className="tasks-column__new-task-form";const c=document.createElement("textarea");c.className="tasks-column__new-task-card-text-element",e.newTaskCard=document.createElement("div"),e.newTaskCard.className="tasks-column__new-task-card",e.newTaskCard.insertAdjacentElement("beforeend",c);const r=document.createElement("button");r.type="button",r.textContent="Добавить карточку",r.className="tasks-column__new-task-button",r.addEventListener("click",(e=>{!function(e){const t=e.currentTarget.closest(".tasks-column").querySelector(".tasks-column__new-task-card-text-element").value;if(""===t)return;const c=e.currentTarget.closest(".tasks-column").querySelector(".tasks-column__new-task-image-container");let r=null,o=null;c&&(r=c.style.backgroundImage,o=c.style.height);const l=new n(t,r,o),m=l.createTaskContainer();e.currentTarget.closest(".tasks-column").querySelector(".tasks-column__column-tasks").insertAdjacentElement("beforeend",m),l.columnNumber=s(m),l.cardNumber=a(m,l.columnNumber),e.currentTarget.closest(".tasks-column__new-task-form").querySelector(".tasks-column__new-task-cancel-button").click(),function(e){let t;const n="cardArray";localStorage.getItem(n)?(t=JSON.parse(localStorage.getItem("cardArray")),t.push(e)):(t=[],t.push(e)),localStorage.setItem(n,JSON.stringify(t))}(l)}(e)}));const o=document.createElement("div");o.className="tasks-column__new-task-image-group",e.newTaskCreateImageInput=document.createElement("input"),e.newTaskCreateImageInput.className="tasks-column__new-task-image-input",e.newTaskCreateImageInput.type="file",e.newTaskCreateImageInput.accept="image/jpeg, image/jpg, image/png";const l=document.createElement("button");l.type="button",l.className="tasks-column__new-task-image-button";const m=document.createElement("button");return m.className="tasks-column__new-task-cancel-button",m.type="button",m.textContent="Отмена",m.addEventListener("click",(e=>{t()})),o.insertAdjacentElement("beforeend",e.newTaskCreateImageInput),o.insertAdjacentElement("beforeend",l),e.newTaskForm.insertAdjacentElement("beforeend",r),e.newTaskForm.insertAdjacentElement("beforeend",o),e.newTaskForm.insertAdjacentElement("beforeend",m),e}();o.insertAdjacentElement("beforeend",l.newTaskCard),r.insertAdjacentElement("beforeend",l.newTaskForm),l.newTaskCreateImageInput.addEventListener("change",(e=>{!function(e){const t=e.currentTarget.files[0],n=new Image,a=new FileReader;a.readAsDataURL(t),a.addEventListener("load",(()=>{n.src=a.result})),n.className="tasks-column__new-task-card",n.addEventListener("load",(()=>{const{naturalHeight:e}=n,{naturalWidth:t}=n,a=document.createElement("div");a.className="tasks-column__new-task-image-container",a.style.backgroundImage=`url(${n.src})`;const s=t/e;s>=1?(a.style.backgroundSize="cover",a.style.height=370/s+"px"):e>300?(a.style.backgroundSize="contain",a.style.height="300px"):(a.style.backgroundSize="contain",a.style.height=`${e}px`);const c=document.querySelector(".tasks-column__new-task-card");c.querySelector(".tasks-column__new-task-image-container")&&c.querySelector(".tasks-column__new-task-image-container").remove(),c.querySelector(".tasks-column__new-task-card-text-element").style.borderRadius="0 0 5px 5px",c.insertAdjacentElement("afterbegin",a)}))}(e)}))}for(let t=0;t<e.length;t+=1)e[t].addEventListener("click",c);window.addEventListener("load",(()=>{if(localStorage.getItem("cardArray")){const e=JSON.parse(localStorage.getItem("cardArray"));e.sort(((e,t)=>e.cardNumber>t.cardNumber?1:-1));const t=document.querySelectorAll(".tasks-column__column-tasks");for(let a=0;a<e.length;a+=1){const{textContent:s,imageUrl:c,imageHeight:r}=e[a],o=new n(s,c,r);o.createDate=e[a].createDate;const l=o.createTaskContainer();t[e[a].columnNumber].insertAdjacentElement("beforeend",l)}}}));const r=document.getElementsByClassName("tasks_board")[0];let o=null;const l=document.createElement("div"),m=document.createElement("div");let u=0,d=0;r.addEventListener("mousedown",(e=>{0===e.button&&e.target.closest(".tasks-column__task-container")&&!e.target.closest(".tasks-column__delete-task-button")&&(o=e.target.closest(".tasks-column__task-container"),o.insertAdjacentElement("afterend",l),l.style.height=`${o.clientHeight}px`,l.style.width=`${o.clientWidth}px`,o.style.width=`${o.clientWidth}px`,o.classList.add("task-dragged"),o.style.top=`${o.offsetTop}px`,o.style.left=`${o.offsetLeft}px`,l.classList.add("tasks-column__task-container"),l.classList.add("task-column__ghost-element"),u=e.clientX+window.scrollX-o.offsetLeft,d=e.clientY+window.scrollY-o.offsetTop,o.style.left=e.clientX-u+"px",o.style.top=e.clientY-d+"px",o.style.transformOrigin=`${e.clientX-o.offsetLeft}px ${e.clientY-o.offsetTop}px`)})),document.getElementsByTagName("body")[0].addEventListener("mousemove",(e=>{if(null===o)return;e.preventDefault(),o.style.left=e.clientX-u+"px",o.style.top=e.clientY-d+"px",m.style.height=`${o.offsetHeight}px`,m.classList.add("task-column__ghost-space");const t=document.elementsFromPoint(e.clientX,e.clientY)[2].closest(".tasks-column"),n=document.elementsFromPoint(e.clientX,e.clientY)[2].closest(".tasks-column__task-container"),a=m.previousSibling,s=m.nextElementSibling;m.style.display=a===l||s===o||s===l?"none":"",null!==t&&(0===t.querySelectorAll(".tasks-column__task-container").length&&t.querySelector(".tasks-column__column-tasks").insertAdjacentElement("beforeend",m),null!==n&&(e.pageY<n.offsetTop+n.offsetHeight/2?n.insertAdjacentElement("beforebegin",m):n.insertAdjacentElement("afterend",m)))})),document.getElementsByTagName("body")[0].addEventListener("mouseup",(e=>{null!==o&&(e.target.closest(".tasks-column")&&m.replaceWith(o),o.classList.remove("task-dragged"),o.removeAttribute("style"),m.remove(),l.remove(),function(e){const t=Number(e.dataset.createDate),n="cardArray",c=JSON.parse(localStorage.getItem(n)),r=c.findIndex((e=>e.createDate===t)),o=s(e),l=a(e,o);if(c[r].columnNumber!==o){for(let e=0;e<c.length;e+=1)c[e].columnNumber===o&&c[e].cardNumber>=l&&(c[e].cardNumber+=1);c[r].cardNumber=l,c[r].columnNumber=o}if(c[r].columnNumber===o){if(c[r].cardNumber<l)for(let e=0;e<c.length;e+=1){const t=c[e];t.columnNumber===o&&t.cardNumber<=l&&t.cardNumber>c[r].cardNumber&&(c[e].cardNumber-=1)}if(c[r].cardNumber>l)for(let e=0;e<c.length;e+=1){const t=c[e];t.columnNumber===o&&t.cardNumber>=l&&t.cardNumber<c[r].cardNumber&&(c[e].cardNumber+=1)}c[r].cardNumber=l}const m=[];for(let e=0;e<3;e+=1){m[e]=[],c.forEach((t=>{t.columnNumber===e&&m[e].push(t)})),m[e].sort(((e,t)=>e.cardNumber-t.cardNumber));for(let t=0;t<m[e].length;t+=1)m[e][t].cardNumber=t}const u=m[0].concat(m[1],m[2]);localStorage.setItem(n,JSON.stringify(u))}(o),o=null)}))})();